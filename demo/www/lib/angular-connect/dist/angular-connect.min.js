/**
 * Authentication library for angular
 * @version v0.0.1-dev-2015-04-26
 * @link 
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="angular-connect"),function(a,b,c,d){b.module("angular-connect",["ngRoute","ngCookies"]),b.module("angular-connect").provider("connect",function(){var a="user",c={},d=[],e=null;this.userPropertyName=function(c){if(arguments.length>0){if(!b.isString(c))throw Error("userPropertyName should be a string");return a=c,this}return a},this.$get=function(b,f){return{login:function(c,g){if(null==e)throw new Error("Framework is not defined");return console.log("connectInstance:login"),e.login(c,g).then(function(c){console.log("connectInstance:login:resolve"),b[a]=c;var e=d.map(function(a){return f.when(c).then(a)});return f.all(e)})},logout:function(c,g){if(null==e)throw new Error("Framework is not defined");return f.when(c).then(function(a){return a?(console.log(a),e.logout(a,g)):void 0}).then(function(){delete b[a];var c=d.map(function(a){return f.when().then(a)});return f.all(c)})},framework:function(a){return e=a,this},user:function(){return b[a]},use:function(a,b){if(b||(b=a,a=b.name),!a)throw new Error("Authentication strategy must have a name");return c[a]=b,this},strategy:function(a){var b=c[a];if(!b)throw new Error('Unknown identification strategy "'+a+'"');return b},unuse:function(a){return delete c[a],this},serializeUser:function(a){d.push(a)},isAuthenticated:function(){return b[a]?!0:!1},userPropertyName:function(){return a}}}}),b.module("angular-connect").factory("connectStrategy",function(a){var b=(this.options={},function(a,b){this.options=a||{},this.verify=b});return b.prototype.login=function(b,c){return a.when()},b.prototype.logout=function(b,c){return a.when()},b.prototype.serializeUser=function(){return a.when()},b.prototype.deserializeUser=function(){return a.when()},b}),b.module("angular-connect").factory("localStrategy",function(a,b,c){var d={redirectTo:""},e=b.userPropertyName()||user;b.serializeUser(function(a){a?localStorage[e]=a:localStorage.removeItem(e)});var f=function(){this.name="local"};return f.prototype=new c,f.prototype.login=function(b,c){return c=c||{},c.redirectTo=c.redirectTo||d.redirectTo,a.when().then(function(){var b=a.defer(),d=localStorage.getItem(e);return d?b.resolve():b.reject({redirectTo:c.redirectTo}),b.promise})},f}),b.module("angular-connect").provider("cookiesStrategy",function(){var a={redirectTo:""};this.$get=function(c,d,e,f){e.serializeUser(function(a){a?d.put("user",a):d.remove("user")});var g=function(c){this.name="cookies",c=b.extend({},c,a),f.call(c)};return g.prototype=new f,g.prototype.login=function(b,e){return e=e||{},e.redirectTo=e.redirectTo||a.redirectTo,c.when().then(function(){var a=c.defer(),b=d.get("user");return b?a.resolve():a.reject({redirectTo:e.redirectTo}),a.promise})},g}}),b.module("angular-connect").factory("oauth2Strategy",function(a,d,e){var f=function(a){this.name="oauth2",e.call(this,a)};return f.prototype=new e,f.prototype.login=function(d,e){var f=this;if(d&&(d.code||d.token))return this.validate(d).then(function(){return f.promise})["catch"](function(c){var d=b.extend({},c,{redirectTo:e.redirectTo||this.options.redirectTo});return a.reject(d)});if(d&&d.error)return a.reject({redirectTo:e.redirectTo||this.options.redirectTo,error:d.error,error_description:d.error_description,error_uri:d.error_uri});var g=c.stringify({client_id:this.options.clientID,redirect_uri:this.options.redirectURL,scope:this.options.scope,response_type:this.options.responseType}),h=this.options.authorizationURL+"?"+g;return a.reject({redirectExt:h})},f.prototype.validate=function(b){return a.when(b)},f}),b.module("angular-connect").factory("sessionStrategy",function(a,b,c){var d={redirectTo:""},e=b.userPropertyName()||user;b.serializeUser(function(a){a?sessionStorage[e]=a:sessionStorage.removeItem(e)});var f=function(){this.name="session"};return f.prototype=new c,f.prototype.login=function(b,c){return c=c||{},c.redirectTo=c.redirectTo||d.redirectTo,a.when().then(function(){var b=a.defer(),d=sessionStorage.getItem(e);return d?b.resolve():b.reject({redirectTo:c.redirectTo}),b.promise})},f}),b.module("angular-connect").factory("ensureLoginStrategy",function(a,c,d){var e={redirectTo:""},f=function(a){this.name="ensureLogin",a=b.extend({},a,e),d.call(this,a)};return f.prototype=new d,f.prototype.login=function(b,d){return d=d||{},d.redirectTo=d.redirectTo||e.redirectTo,console.log(d),a.when().then(function(){var b=a.defer();return c.isAuthenticated()?b.resolve():b.reject({redirectTo:d.redirectTo}),b.promise})},f}),b.module("angular-connect").factory("ensureLogoutStrategy",function(a,c,d){var e={redirectTo:""},f=function(a){this.name="ensureLogout",a=b.extend({},a,e),d.call(this,a)};return f.prototype=new d,f.prototype.logout=function(b,d){return console.log("ensureLogoutStrategy:logout"),d=d||{},d.redirectTo=d.redirectTo||e.redirectTo,a.when().then(function(){var b=a.defer();return c.isAuthenticated()?(console.log("ensureLogoutStrategy:logout:reject"),b.reject({redirectTo:d.redirectTo})):b.resolve(),b.promise})},f}),b.module("angular-connect").service("ngRouteFramework",function(a,c,e,f,g,h){return c.$on("$routeChangeError",function(b,e,g,h){h.redirectTo!==d&&(console.log("redirectTo",h.redirectTo),c.$evalAsync(function(){f.path(h.redirectTo)})),h.redirectExt!==d&&(console.log("redirectExt",h.redirectExt),c.$evalAsync(function(){a.location.replace(h.redirectExt)}))}),c.$on("$routeChangeSuccess",function(a,b,c,d){console.log("success",d)}),{login:function(a,c){b.isArray(a)||(a=[a]);var d,h=f.search();return b.forEach(a,function(a,b){d=0===b?g.when(e.strategy(a).login(h,c)):d["catch"](function(){return e.strategy(a).login(h,c)})}),d},logout:function(a,c){b.isArray(a)||(a=[a]);var d;return b.forEach(a,function(a,b){d=0===b?g.when(e.strategy(a).logout(c)):d["catch"](function(){return e.strategy(a).logout(c)})}),d}}}),b.module("angular-connect-uiRouter",["angular-connect","ui.router"]).service("uiRouterFramework",function(a,c,e,f,g,h){return a.$on("$stateChangeStart",function(a,b,c,d,e){console.log(JSON.stringify(d))}),a.$on("$stateChangeError",function(b,e,f,g,h,i){a.$returnTo={state:e,params:f},i.redirectTo!==d&&(console.log("redirectTo",i.redirectTo),a.$evalAsync(function(){c.go(i.redirectTo)}))}),a.$on("$stateChangeSuccess",function(b,d,e,f,g){a.successReturnToOrRedirect&&(b.preventDefault(),a.$evalAsync(function(){c.go(a.$returnTo.state.name)}))}),{login:function(c,d){b.isArray(c)||(c=[c]);var g,i=e;return b.forEach(c,function(b,c){g=0===c?h.when(f.strategy(b).login(i,d)):g["catch"](function(){return f.strategy(b).login(i,d)}),g=g.then(function(b){d=d||{},d.successReturnToOrRedirect&&(a.successReturnToOrRedirect=d.successReturnToOrRedirect)})}),g},logout:function(a,c){b.isArray(a)||(a=[a]);var d,g=e;return b.forEach(a,function(a,b){d=0===b?h.when(f.strategy(a).logout(g,c)):d["catch"](function(){return f.strategy(a).logout(g,c)})}),d}}})}(window,window.angular,window.queryString);